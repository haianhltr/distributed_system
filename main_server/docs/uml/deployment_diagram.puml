@startuml Deployment Diagram

!define NODE node
!define CONTAINER container

node "Host Machine" {
    node "Docker Environment" {
        container "Main Server Container" {
            [FastAPI Application] as FastAPI
            [Job Service] as JobSvc
            [Bot Service] as BotSvc
            [Cleanup Service] as CleanupSvc
            [Database Manager] as DBManager
            [Data Lake Manager] as DatalakeMgr
            [Background Tasks] as BgTasks
        }
        
        container "PostgreSQL Container" {
            database "PostgreSQL Database" as PostgreSQL {
                [jobs table] as JobsTable
                [bots table] as BotsTable
                [results table] as ResultsTable
            }
        }
        
        container "Dashboard Container" {
            [Web Dashboard] as Dashboard
            [Static Files] as StaticFiles
            [Templates] as Templates
        }
    }
    
    node "External Bots" {
        [Worker Bot 1] as Bot1
        [Worker Bot 2] as Bot2
        [Worker Bot N] as BotN
    }
    
    node "Admin Tools" {
        [CLI Tools] as CLI
        [Monitoring Tools] as Monitoring
    }
}

node "File System" {
    folder "Data Lake" {
        [Daily Results Files] as ResultsFiles
        [Log Files] as LogFiles
    }
}

' Network connections
Bot1 --> FastAPI : HTTP REST API (Port 3001)
Bot2 --> FastAPI : HTTP REST API (Port 3001)
BotN --> FastAPI : HTTP REST API (Port 3001)

Dashboard --> FastAPI : HTTP REST API (Port 3001)
CLI --> FastAPI : HTTP REST API (Port 3001)
Monitoring --> FastAPI : HTTP REST API (Port 3001)

' Internal container connections
FastAPI --> JobSvc
FastAPI --> BotSvc
FastAPI --> CleanupSvc
FastAPI --> DBManager
FastAPI --> DatalakeMgr

JobSvc --> DBManager
BotSvc --> DBManager
CleanupSvc --> DBManager

DBManager --> PostgreSQL : Port 5432
DatalakeMgr --> ResultsFiles : File I/O

BgTasks --> DBManager
BgTasks --> DatalakeMgr

' Port mappings
note right of FastAPI
  Exposed Ports:
  - 3001: Main API
  - 8000: Dashboard
end note

note right of PostgreSQL
  Database Port: 5432
  Internal Network
end note

note right of Dashboard
  Web Interface:
  - Port 8000
  - HTML/CSS/JS
  - Real-time updates
end note

' Environment variables
note bottom of "Main Server Container"
  Environment Variables:
  - DATABASE_URL
  - DATALAKE_PATH
  - ADMIN_TOKEN
  - POPULATE_INTERVAL_MS
  - BATCH_SIZE
end note

note bottom of "PostgreSQL Container"
  Environment Variables:
  - POSTGRES_DB
  - POSTGRES_USER
  - POSTGRES_PASSWORD
end note

' Volume mounts
note left of "Data Lake"
  Volume Mounts:
  - ./datalake:/app/datalake
  - ./logs:/app/logs
end note

note left of "PostgreSQL Container"
  Volume Mounts:
  - postgres_data:/var/lib/postgresql/data
end note

@enduml
